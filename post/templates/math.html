<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Math - Edu-File</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='sub.css') }}">
</head>
<body>
    <nav class="navbar">
        <div class="logo">
            <img src="{{ url_for('static', filename='edulogo.png') }}" alt="Logo" style="height:35px; vertical-align:middle; margin-right:8px;">
        </div>
        <div class="nav-links">
            <a href="{{ url_for('home') }}">
                <img src="{{ url_for('static', filename='home.png') }}" alt="Home" style="height:20px; vertical-align:middle; position: relative; top: -3px; margin-left: -37px;">   
                <span style="position:relative; left: -6px;">HOME</span>
            </a>
            <a href="{{ url_for('sub') }}">
                <img src="{{ url_for('static', filename='book.png') }}" alt="Subject" style="height:42px; vertical-align:middle; position: relative; margin-left: -37px;">    
                <span style="position:relative; left: -16px;">SUBJECT</span>
            </a>
            <a href="{{ url_for('set') }}">
                <img src="{{ url_for('static', filename='set.png') }}" alt="Setting" style="height:20px; vertical-align:middle; position: relative; top: -2px; margin-left: -37px;">    
                <span style="position:relative; left: -5px;">SETTING</span>
            </a>
        </div>
        <div class="user-menu">
            <i class="fa fa-user"></i> {{ user }}
        </div>
    </nav>

    <!-- Search Bar -->
    <div class="search-container">
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏û‡∏™‡∏ï‡πå..." onkeyup="searchPosts()">
            <span class="search-icon">üîç</span>
        </div>
    </div>

    <div class="posts">
        {% for post in posts %}
        <div class="post" data-post-text="{{ post.text|e }}" data-post-user="{{ post.user }}">
            <div class="post-header">
                <div class="user-info">
                    <i class="fa fa-user"></i> 
                    <span class="username">{{ post.user }}</span>
                </div>
            </div>

            {% if post.category_display %}
            <span class="post-category {{ post.category_class }}">{{ post.category_display }}</span>
            {% endif %}

            <div class="post-content">
                <div class="post-text">{{ post.text|e }}</div>
                {% if post.file %}
                <div class="post-file">
                    {% if post.file.endswith('.pdf') %}
                        <a href="{{ url_for('static', filename='uploads/' + post.file) }}" target="_blank" class="pdf-card">
                            <div class="pdf-icon">
                                <img src="{{ url_for('static', filename='doc.png') }}" alt=" " style="height:30px; width:30px; vertical-align: middle; margin-right: 1px; margin-top:-1px;">
                            </div>
                            <div class="pdf-info">
                                <p class="pdf-title">{{ post.file.split('_', 1)[1] if '_' in post.file else post.file }}</p>
                            </div>
                        </a>
                    {% else %}
                        <img src="{{ url_for('static', filename='uploads/' + post.file) }}" alt="‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå" class="attached-img">
                    {% endif %}
                </div>
                {% endif %}
            </div>

            <div class="post-card" data-post-id="{{ post.id }}">
                <div class="interactions">
                    <button class="btn {% if post.user_liked %}liked{% endif %}" onclick="likePost(this)">
                        üëç <span class="like-count">{{ post.like_count }}</span>
                    </button>
                    <button class="btn" onclick="toggleCommentBox(this)">
                        üí¨ <span class="comment-count">{{ post.comment_count }}</span>
                    </button>
                </div>

                <div class="comment-box hidden">
                    <input type="text" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô...">
                    <button class="btn btn-primary" onclick="addComment(this)">‡πÇ‡∏û‡∏™‡∏ï‡πå</button>
                </div>

                <div class="comment-list" style="display:none;"></div>
            </div>
        </div>
        {% endfor %}
    </div>

    <script>
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏û‡∏™‡∏ï‡πå
    function searchPosts() {
        const input = document.getElementById('searchInput').value.toLowerCase();
        const posts = document.querySelectorAll('.post');
        
        posts.forEach(post => {
            const text = post.dataset.postText.toLowerCase();
            const user = post.dataset.postUser.toLowerCase();
            
            if (text.includes(input) || user.includes(input)) {
                post.style.display = '';
            } else {
                post.style.display = 'none';
            }
        });
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏î‡πÑ‡∏•‡∏Ñ‡πå - ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö database
    async function likePost(button) {
        const postCard = button.closest(".post-card");
        const postId = postCard.dataset.postId;
        
        button.disabled = true;
        
        try {
            const response = await fetch(`/api/like/${postId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                const likeCount = button.querySelector(".like-count");
                likeCount.innerText = data.like_count;
                
                if (data.liked) {
                    button.classList.add("liked");
                } else {
                    button.classList.remove("liked");
                }
            }
        } catch (error) {
            console.error('Error:', error);
            alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡πÑ‡∏•‡∏Ñ‡πå');
        } finally {
            button.disabled = false;
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå
    async function toggleCommentBox(button) {
        const postCard = button.closest(".post-card");
        const postId = postCard.dataset.postId;
        const commentBox = postCard.querySelector(".comment-box");
        const commentList = postCard.querySelector(".comment-list");

        commentBox.classList.toggle("hidden");

        if (commentList.style.display === "none" || commentList.style.display === "") {
            await loadComments(postId, commentList);
            commentList.style.display = "block";
        } else {
            commentList.style.display = "none";
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏à‡∏≤‡∏Å database
    async function loadComments(postId, commentList) {
        try {
            const response = await fetch(`/api/comments/${postId}`);
            const data = await response.json();
            
            if (data.success) {
                commentList.innerHTML = '';
                
                data.comments.forEach(comment => {
                    const p = document.createElement("p");
                    p.className = "comment";
                    p.innerHTML = `<b>${comment.username}:</b> <span class="comment-text">${comment.text}</span>`;
                    commentList.appendChild(p);
                });
            }
        } catch (error) {
            console.error('Error loading comments:', error);
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå
    async function addComment(button) {
        const postCard = button.closest(".post-card");
        const postId = postCard.dataset.postId;
        const input = postCard.querySelector("input");
        const text = input.value.trim();
        
        if (text === "") return;
        
        button.disabled = true;
        
        try {
            const response = await fetch(`/api/comment/${postId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ text: text })
            });
            
            const data = await response.json();
            
            if (data.success) {
                const commentList = postCard.querySelector(".comment-list");
                const p = document.createElement("p");
                p.className = "comment";
                p.innerHTML = `<b>${data.username}:</b> <span class="comment-text">${data.text}</span>`;
                commentList.appendChild(p);
                
                const commentCount = postCard.querySelector(".comment-count");
                commentCount.innerText = data.comment_count;
                
                input.value = "";
                commentList.style.display = "block";
            }
        } catch (error) {
            console.error('Error:', error);
            alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå');
        } finally {
            button.disabled = false;
        }
    }
    </script>
</body>
</html>