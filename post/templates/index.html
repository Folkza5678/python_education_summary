<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Edu-File</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}">
</head>
<body>
    <nav class="navbar">
        <div class="logo">
            <img src="{{ url_for('static', filename='edulogo.png') }}" alt="Logo" style="height:35px; vertical-align:middle; margin-right:8px;">
        </div>
        <div class="nav-links">
            <a href="{{ url_for('home') }}">
                <img src="{{ url_for('static', filename='home.png') }}" alt="Home" style="height:20px; vertical-align:middle; position: relative; top: -3px; margin-left: -37px;">   
                <span style="position:relative; left: -6px;">HOME</span>
            </a>
            <a href="{{ url_for('sub') }}">
                <img src="{{ url_for('static', filename='book.png') }}" alt="Subject" style="height:42px; vertical-align:middle; position: relative; margin-left: -37px;">    
                <span style="position:relative; left: -16px;">SUBJECT</span>
            </a>
            <a href="{{ url_for('set') }}">
                <img src="{{ url_for('static', filename='set.png') }}" alt="Setting" style="height:20px; vertical-align:middle; position: relative; top: -2px; margin-left: -37px;">    
                <span style="position:relative; left: -5px;">SETTING</span>
            </a>
        </div>
        <div class="user-menu">
            <i class="fa fa-user"></i> {{ user }}
        </div>
    </nav>

    <div class="container">
        <div class="post-form-container">
            <div class="form-header">
                <i class="fa fa-user"></i> {{ user }}
            </div>
            <form class="post-form" method="post" enctype="multipart/form-data">
                <textarea id="summary-textarea" name="summary" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏£‡∏∏‡∏õ..." required></textarea>
                
                <div class="category-selection">
                    <label for="category">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà:</label>
                    <select id="category" name="category" required>
                        <option value="">Select Subjects</option>
                        <option value="math">Mathematics</option>
                        <option value="physics">Physics</option>
                        <option value="biology">Biology</option>
                        <option value="chemistry">Chemistry</option>
                        <option value="history">History</option>
                        <option value="thai">Thai</option>
                    </select>
                </div>
                
                <div class="file-upload-box">
                    <input type="file" id="file-upload" name="file" accept=".pdf,image/*" hidden>
                    <label for="file-upload" class="custom-file-label">
                        <img src="{{ url_for('static', filename='z.png') }}" alt="file icon" style="height: 22px; vertical-align: middle; margin-right: -3px;">
                        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå
                    </label>
                    <span id="file-name" class="file-name-label">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</span>
                </div>
                <button type="submit">POST</button>
            </form>
        </div>
    </div>

    <div class="posts">
        {% for post in posts %}
        <div class="post">
            <div class="post-header">
    <div class="user-info">
        <i class="fa fa-user"></i> 
        <span class="username">{{ post.user }}</span>
    </div>
    
</div>
             

            {% if post.category_display %}
            <span class="post-category {{ post.category_class }}">{{ post.category_display }}</span>
            {% endif %}

            {% if post.user == user %}
             <div class="post-menu-container">
        <button class="post-menu-btn" onclick="togglePostMenu(event, this)">‚ãÆ</button>
        <div class="post-menu-dropdown hidden" data-post-id="{{ post.id }}">
            <button onclick="deletePost(event, this.parentElement.dataset.postId)">     Delete</button>
        </div>
    </div>
    {% endif %}

            <div class="post-content">
                <div class="post-text">{{ post.text|e }}</div>
                {% if post.file %}
                <div class="post-file">
                    {% if post.file.endswith('.pdf') %}
                        <a href="{{ url_for('static', filename='uploads/' + post.file) }}" target="_blank" class="pdf-card">
                            <div class="pdf-icon">
                                <img src="{{ url_for('static', filename='doc.png') }}" alt=" " style="height:30px; width:30px; vertical-align: middle; margin-right: 1px; margin-top:-1px;">
                            </div>
                            <div class="pdf-info">
                                <p class="pdf-title">{{ post.file.split('_', 1)[1] if '_' in post.file else post.file }}</p>
                            </div>
                        </a>
                    {% else %}
                        <img src="{{ url_for('static', filename='uploads/' + post.file) }}" alt="‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå" class="attached-img">
                    {% endif %}
                </div>
                {% endif %}
            </div>

            <div class="post-card" data-post-id="{{ post.id }}">
                <div class="interactions">
                    <button class="btn {% if post.user_liked %}liked{% endif %}" onclick="likePost(this)">
                        üëç <span class="like-count">{{ post.like_count }}</span>
                    </button>
                    <button class="btn" onclick="toggleCommentBox(this)">
                        üí¨ <span class="comment-count">{{ post.comment_count }}</span>
                    </button>
                </div>

                <div class="comment-box hidden">
                    <input type="text" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô...">
                    <button class="btn btn-primary" onclick="addComment(this)">‡πÇ‡∏û‡∏™‡∏ï‡πå</button>
                </div>

                <div class="comment-list" style="display:none;"></div>
            </div>
        </div>
        {% endfor %}
    </div>

    <script>
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡πÇ‡∏û‡∏™‡∏ï‡πå
function togglePostMenu(event, button) {
    event.stopPropagation();
    const dropdown = button.nextElementSibling;
    
    // ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    document.querySelectorAll('.post-menu-dropdown').forEach(menu => {
        if (menu !== dropdown) {
            menu.classList.add('hidden');
        }
    });
    
    dropdown.classList.toggle('hidden');
}

// ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏∑‡πà‡∏ô
document.addEventListener('click', function(event) {
    if (!event.target.closest('.post-menu-container')) {
        document.querySelectorAll('.post-menu-dropdown').forEach(menu => {
            menu.classList.add('hidden');
        });
    }
});

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡πÇ‡∏û‡∏™‡∏ï‡πå
async function deletePost(event, postId) {
    event.stopPropagation();
    
    try {
        const response = await fetch(`/api/delete_post/${postId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // ‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏•‡∏ö‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏à‡∏≤‡∏Å DOM
            const postElement = event.target.closest('.post');
            postElement.style.transition = 'opacity 0.3s, transform 0.3s';
            postElement.style.opacity = '0';
            postElement.style.transform = 'translateY(-20px)';
            
            setTimeout(() => {
                postElement.remove();
            }, 300);
        } else {
            alert(data.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÇ‡∏û‡∏™‡∏ï‡πå');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÇ‡∏û‡∏™‡∏ï‡πå');
    }
}// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡πÇ‡∏û‡∏™‡∏ï‡πå
async function deletePost(event, postId) {
    event.stopPropagation();
    
    try {
        const response = await fetch(`/api/delete_post/${postId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // ‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏•‡∏ö‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏à‡∏≤‡∏Å DOM
            const postElement = event.target.closest('.post');
            postElement.style.transition = 'opacity 0.3s, transform 0.3s';
            postElement.style.opacity = '0';
            postElement.style.transform = 'translateY(-20px)';
            
            setTimeout(() => {
                postElement.remove();
            }, 300);
        } else {
            alert(data.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÇ‡∏û‡∏™‡∏ï‡πå');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÇ‡∏û‡∏™‡∏ï‡πå');
    }
}
    // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    const fileInput = document.getElementById('file-upload');
    const fileNameLabel = document.getElementById('file-name');

    fileInput.addEventListener('change', function() {
      if (this.files && this.files.length > 0) {
        const file = this.files[0];
        fileNameLabel.textContent = file.name;
        fileNameLabel.style.color = '#2c5f7c';
        fileNameLabel.style.fontWeight = 'bold';
        fileNameLabel.style.cursor = 'pointer';
        
        fileNameLabel.onclick = function() {
          const url = URL.createObjectURL(file);
          window.open(url, '_blank');
        };
      } else {
        fileNameLabel.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å';
        fileNameLabel.style.color = '#666';
        fileNameLabel.style.fontWeight = 'normal';
        fileNameLabel.style.cursor = 'default';
        fileNameLabel.onclick = null;
      }
    });

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏î‡πÑ‡∏•‡∏Ñ‡πå - ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö database
    async function likePost(button) {
      const postCard = button.closest(".post-card");
      const postId = postCard.dataset.postId;
      
      button.disabled = true; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡∏ã‡πâ‡∏≥
      
      try {
        const response = await fetch(`/api/like/${postId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          const likeCount = button.querySelector(".like-count");
          likeCount.innerText = data.like_count;
          
          // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏•‡∏Ñ‡πå
          if (data.liked) {
            button.classList.add("liked");
          } else {
            button.classList.remove("liked");
          }
        }
      } catch (error) {
        console.error('Error:', error);
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡πÑ‡∏•‡∏Ñ‡πå');
      } finally {
        button.disabled = false;
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå
    async function toggleCommentBox(button) {
      const postCard = button.closest(".post-card");
      const postId = postCard.dataset.postId;
      const commentBox = postCard.querySelector(".comment-box");
      const commentList = postCard.querySelector(".comment-list");

      commentBox.classList.toggle("hidden");

      // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å database
      if (commentList.style.display === "none" || commentList.style.display === "") {
        await loadComments(postId, commentList);
        commentList.style.display = "block";
      } else {
        commentList.style.display = "none";
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏à‡∏≤‡∏Å database - ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠ user ‡∏ó‡∏µ‡πà‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå
    async function loadComments(postId, commentList) {
      try {
        const response = await fetch(`/api/comments/${postId}`);
        const data = await response.json();
        
        if (data.success) {
          commentList.innerHTML = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡πÄ‡∏Å‡πà‡∏≤
          
          data.comments.forEach(comment => {
            const p = document.createElement("p");
            p.className = "comment";
            // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠ user ‡∏ó‡∏µ‡πà‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏à‡∏≤‡∏Å database
            p.innerHTML = `<b>${comment.username}:</b> <span class="comment-text">${comment.text}</span>`;
            commentList.appendChild(p);
          });
        }
      } catch (error) {
        console.error('Error loading comments:', error);
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå - ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á database ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡∏∑‡πà‡∏≠ user
    async function addComment(button) {
      const postCard = button.closest(".post-card");
      const postId = postCard.dataset.postId;
      const input = postCard.querySelector("input");
      const text = input.value.trim();
      
      if (text === "") return;
      
      button.disabled = true; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡∏ã‡πâ‡∏≥
      
      try {
        const response = await fetch(`/api/comment/${postId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ text: text })
        });
        
        const data = await response.json();
        
        if (data.success) {
          // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô UI ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡∏∑‡πà‡∏≠ user ‡∏ó‡∏µ‡πà‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå
          const commentList = postCard.querySelector(".comment-list");
          const p = document.createElement("p");
          p.className = "comment";
          p.innerHTML = `<b>${data.username}:</b> <span class="comment-text">${data.text}</span>`;
          commentList.appendChild(p);
          
          // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå
          const commentCount = postCard.querySelector(".comment-count");
          commentCount.innerText = data.comment_count;
          
          // ‡∏•‡πâ‡∏≤‡∏á input
          input.value = "";
          
          // ‡πÅ‡∏™‡∏î‡∏á comment list
          commentList.style.display = "block";
        }
      } catch (error) {
        console.error('Error:', error);
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå');
      } finally {
        button.disabled = false;
      }
    }
    </script>
</body>
</html>